<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSL证书助手 - 管理中心</title>
    <link href="static/style-all.css" rel="stylesheet"/>
    <link href="static/bootstrap.css" rel="stylesheet">
    <script src="static/crypt-min.js"></script>
    <script src="static/panel-min.js"></script>
    <script src="static/certs-min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
</head>
<body>
<div class="container">
    <div id="sides-bar"></div>
    <div class="content" style="min-height: 900px">
        <div class="main-content">
            <div class="form-section">
                <h2>证书统计</h2>
                <div class="chart-container">
                    <div class="chart">
                        <h3>待验证</h3>
                        <div class="pie-chart" id="cert_wait"></div>
                    </div>
                    <div class="chart">
                        <h3>验证中</h3>
                        <div class="pie-chart" id="cert_auth"></div>
                    </div>
                    <div class="chart">
                        <h3>已签发</h3>
                        <div class="pie-chart" id="cert_done"></div>
                    </div>
                    <div class="chart">
                        <h3>已失效</h3>
                        <div class="pie-chart" id="cert_fail"></div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h2>消息通知</h2>
                <table class="orders-table">
                    <thead>
                    <tr>
                        <th>订单ID</th>
                        <th>时间</th>
                        <th>消息</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody id="msg_list">
                    </tbody>
                </table>
            </div>
            <div class="form-section">
                <h2 onclick="toggleSection('acme-section')" style="cursor: pointer;">ACME账号 <span
                        id="acme-arrow">▼</span></h2>
                <div id="acme-section" style="display: none">
                    <br/>
                    <textarea rows="2" id="acme_key" placeholder="留空则不更改"></textarea>
                    <button type="button" class="btn btn-info" onclick="newECCP256()">随机生成</button>
                    <button type="button" class="btn btn-success" onclick="postSubmit('acme_key','acmes')">应用更改
                    </button>
                </div>
            </div>
            <div class="form-section">
                <h2 onclick="toggleSection('user-section')" style="cursor: pointer;">用户操作 <span
                        id="user-arrow">▼</span></h2>
                <div id="user-section" style="display: none">
                    <br/>
                    <label for="apis_key">API 密钥: </label>
                    <input id="apis_key" class="form-control" style="display: unset;width: auto;max-width: 240px"
                           placeholder="留空则不更改"></input>
                    <button type="button" class="btn btn-info" onclick="newAPIKeys()">随机生成</button>
                    <button type="button" class="btn btn-success" onclick="postSubmit('apis_key','token')">应用更改
                    </button>
                    <label id="user_act">账号操作: </label>
                    <button type="button" class="btn btn-warning" onclick="passModify()">修改密码</button>
                    <button type="button" class="btn btn-danger" onclick="delAccount()">删除账号</button>
                    <br/><label id="code_act" style="margin-top: 15px">通过API获取证书示例: </label><br/><code id="api_example"></code>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/echarts@5.6.0/dist/echarts.min.js"></script>
<script>
    function toggleSection(sectionId) {
        var section = document.getElementById(sectionId);
        var arrow = document.getElementById(sectionId.split('-')[0] + '-arrow');

        if (section.style.display === "none") {
            section.style.display = "block";
            arrow.textContent = "▼";
        } else {
            section.style.display = "none";
            arrow.textContent = "▶";
        }
    }
</script>
<script>
    srtGravatar("panel");
    numOrders();

    // 填充APIS密钥 ==========================================================================
    async function newAPIKeys() {
        try {
            document.getElementById("apis_key").value = Math.random().toString(36).slice(2);
        } catch (error) {
            console.error("生成密钥失败:", error);
            throw error;
        }
    }

    // 填充ACME密钥 ===========================================================================
    async function newECCP256() {
        try {
            const {publicKey, privateKey} = await crypto.subtle.generateKey(
                {name: "ECDSA", namedCurve: "P-256"}, true, ["sign", "verify"],
            );
            document.getElementById("acme_key").value = await encodePEM(privateKey);
        } catch (error) {
            console.error("生成密钥对失败:", error);
            throw error;
        }
    }

    // 生成ACME密钥 ===========================================================================
    async function encodePEM(privateKey) {
        // 将 ArrayBuffer 转换为 Base64 字符串
        const keyBuff = await crypto.subtle.exportKey("pkcs8", privateKey);
        const keyByte = String.fromCharCode.apply(null, new Uint8Array(keyBuff));
        const keyBase = window.btoa(keyByte);
        // 添加 PEM 标头和尾部，并每 64 个字符换行
        let pem = "-----BEGIN PRIVATE KEY-----\n";
        for (let i = 0; i < keyBase.length; i += 64) {
            pem += keyBase.substring(i, i + 64) + "\n";
        }
        pem += "-----END PRIVATE KEY-----";

        return pem;
    }

    // 提交ACME密钥 ===========================================================================
    const xhr = new XMLHttpRequest();

    async function postSubmit(update_name, update_path) {
        const acme_key = document.getElementById(update_name).value
        if (acme_key.length <= 5) {
            Swal.fire({
                icon: 'error',
                title: '请先填写或者生成新的ACME密钥',
                showConfirmButton: false,
                timer: 1000
            });
            return false;
        }
        if (update_path === 'acmes') {
            let {isConfirmed} = await Swal.fire({
                title: '确认更新ACME私钥',
                text: '您将无法使用之前的密钥吊销已申请的证书' +
                    '\n注意：此密钥在离开本页面后不可再次查看',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '更新密钥',
                cancelButtonText: '取消',
            })
            if (!isConfirmed) return;
        } else if (update_path === 'token') {
            let {isConfirmed} = await Swal.fire({
                title: '确认更新API密钥',
                text: '如果您设置了自动更新，需要同步更换密钥' +
                    '\n注意：此密钥在离开本页面后不可再次查看',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '更新密钥',
                cancelButtonText: '取消',
            })
            if (!isConfirmed) return;
        }

        xhr.open('POST', update_path + "/", false); // 第三个参数设置为 false 表示同步请求
        xhr.setRequestHeader('Content-Type', 'application/json');
        const data = {
            privateKey: acme_key,
            // 可以添加其他需要发送的数据
        };
        xhr.send(JSON.stringify(data));
        if (xhr.status === 200) {
            const response = JSON.parse(xhr.responseText);
            if (response.flags === 0) {
                Swal.fire({
                    icon: 'info',
                    title: '更新ACME密钥成功',
                    showConfirmButton: false,
                    timer: 1000
                });
            } else {
                console.log('用户邮箱获取失败:',);
                Swal.fire({
                    icon: 'info',
                    title: '更新ACME密钥失败\n' + response.texts,
                    showConfirmButton: false,
                    timer: 1000
                });
            }
        } else {
            Swal.fire({
                icon: 'error',
                title: '网络错误或服务器不可达',
                showConfirmButton: false,
                timer: 1000
            });
        }
    }

    // 动态填充 API 示例域名
    (function fillApiExample() {
        var origin = window.location.origin;
        var el = document.getElementById('api_example');
        if (el) {
            el.innerHTML = `curl -X GET "${origin}/certs/订单ID?keys=API密钥" -H "Content-Type: application/json" -o res.json<br/>jq -r '.cert' res.json > /to/your/path/cert.pem && jq -r '.keys' res.json > /to/your/path/keys.pem`;
        }
    })();

    // 删除当前账号 ===========================================================================
    function delAccount() {
        // 显示确认对话框
        const email = document.getElementById("user-emails").innerText
        Swal.fire({
            title: '确认删除账号',
            text: '此操作不可逆转，你确定要删除此账号？\n' +
                '此账号所对应的证书订单将会被一并删除\n' +
                '请输入你的邮箱' + email + '以确认',
            icon: 'warning',
            input: 'text',
            inputLabel: '输入你的邮箱进行确认',
            inputPlaceholder: '请输入你的邮箱',
            showCancelButton: true,
            confirmButtonText: '删除账号',
            cancelButtonText: '取消',
            inputValidator: (value) => {
                if (!value) {
                    return '请输入您的邮箱';
                }
                if (value !== email) {
                    return '请输入正确邮箱';
                }
                return null;
            }
        }).then((result) => {
            if (result.isConfirmed) {
                const email = result.value;
                xhr.open('POST', '/erase/', false); // 第三个参数设置为 false 表示同步请求
                xhr.setRequestHeader('Content-Type', 'application/json');
                const data = {email: email};
                xhr.send(JSON.stringify(data));
                if (xhr.status === 200) {
                    const response = JSON.parse(xhr.responseText);
                    if (response.flags === 0) {
                        Swal.fire({
                            icon: 'info',
                            title: '删除账号成功',
                            showConfirmButton: false,
                            timer: 1000
                        });
                        window.location.href = "/index.html";
                    } else {
                        Swal.fire({
                            icon: 'info',
                            title: '删除账号失败\n' + response.texts,
                            showConfirmButton: false,
                            timer: 1000
                        });
                    }
                } else {
                    Swal.fire({
                        icon: 'info',
                        title: '删除账号失败\n' + xhr.status,
                        showConfirmButton: false,
                        timer: 1000
                    });
                }
            }
        });
    }

    // 修改用户密码 ===========================================================================
    function passModify() {
        const email = document.getElementById("user-emails").innerText
        window.location.href = "/login.html?changers=1&emails=" + email;
    }
</script>
</body>
</html>
